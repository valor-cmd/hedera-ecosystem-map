<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hedera Ecosystem Map</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      background: #000000;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Common Search Bar Styles */
    .search-bar {
      display: flex;
      align-items: center;
      background: #000000;
      border: 2px solid #8b5cf6;
      border-radius: 50px;
      padding: 8px 8px 8px 20px;
      width: 280px;
      position: relative;
    }

    .search-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: #ffffff;
      font-size: 14px;
      font-family: inherit;
      min-width: 0;
    }

    .search-input::placeholder {
      color: #888888;
    }

    .search-button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #8b5cf6;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
    }

    .search-button:hover {
      background: #7c3aed;
    }

    .search-button svg {
      width: 18px;
      height: 18px;
      fill: #ffffff;
    }

    /* Desktop Search Bar Overrides */
    @media (min-width: 769px) {
      .search-bar {
        border: 1px solid #666666;
        padding: 4px 4px 4px 16px;
        width: 220px;
      }

      .search-button {
        width: 24px;
        height: 24px;
        background: #000000;
        border: 1px solid #666666;
      }

      .search-button:hover {
        background: #1a1a1a;
      }

      .search-button svg {
        width: 12px;
        height: 12px;
        fill: #888888;
      }

      .search-input {
        font-size: 12px;
      }

      .search-result {
        font-size: 11px;
        right: 32px;
        left: 16px;
      }
    }

    .search-result {
      position: absolute;
      left: 16px;
      right: 44px;
      color: #10b981;
      font-size: 12px;
      font-weight: 500;
      display: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1;
      top: 50%;
      transform: translateY(-50%);
    }

    .search-result.not-found {
      color: #ef4444;
    }

    .search-result.visible {
      display: block;
    }

    .search-result.visible + .search-input {
      visibility: hidden;
    }

    /* Pulse Animation for found logos - scale only, no glow */
    @keyframes logo-pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
      }
    }

    .logo-pulsing {
      animation: logo-pulse 0.8s ease-in-out infinite;
      z-index: 100;
      transform-box: fill-box;
      transform-origin: center center;
    }

    /* SVG image pulse - needs transform-box to pulse in place */
    svg image.logo-pulsing {
      animation: logo-pulse 0.8s ease-in-out infinite;
      transform-box: fill-box;
      transform-origin: center center;
    }

    /* Footer logo pulse */
    .mobile-footer img.logo-pulsing {
      animation: logo-pulse 0.8s ease-in-out infinite;
    }

    /* Desktop styles */
    @media (min-width: 769px) {
      html, body {
        overflow: hidden;
      }

      .map-container {
        width: 100vw;
        height: 100vh;
        padding: 20px 45px;
        box-sizing: border-box;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .map-container svg {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .mobile-container {
        display: none !important;
      }

      /* Desktop Search Bar - positioned dynamically via JS */
      .desktop-search-container {
        position: absolute;
        z-index: 1000;
        pointer-events: auto;
      }

      .desktop-search-container .search-bar {
        border: 1px solid #666666;
        padding: 4px 4px 4px 12px;
        background: #000000;
      }

      .desktop-search-container .search-button {
        width: 20px;
        height: 20px;
        background: #000000;
        border: 1px solid #666666;
      }

      .desktop-search-container .search-button svg {
        width: 10px;
        height: 10px;
        fill: #888888;
      }

      .desktop-search-container .search-input {
        font-size: 11px;
      }

      .desktop-search-container .search-result {
        font-size: 10px;
        right: 28px;
        left: 12px;
      }
    }

    /* Mobile styles */
    @media (max-width: 768px) {
      html, body {
        overflow-x: hidden;
        overflow-y: auto;
        height: auto;
      }

      .map-container {
        display: none !important;
      }

      .modal-overlay {
        display: none !important;
      }

      .desktop-search-container {
        display: none !important;
      }

      .top-link {
        position: relative !important;
        display: block;
        text-align: center;
        padding: 12px;
        top: auto !important;
        right: auto !important;
        border-bottom: 1px solid rgba(139, 92, 246, 0.3);
      }

      .mobile-container {
        display: block;
        padding: 16px;
        padding-bottom: 40px;
      }

      .mobile-header {
        text-align: center;
        padding: 20px 0 24px;
        border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        margin-bottom: 20px;
      }

      .mobile-header h1 {
        color: #ffffff;
        font-size: 30px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .mobile-header p {
        color: #ffffff;
        font-size: 12px;
      }

      /* Mobile Search Container */
      .search-container {
        display: flex;
        justify-content: center;
        margin-top: 16px;
      }

      /* Mobile Search Bar Styling */
      .search-bar {
        border: 1px solid #666666;
      }

      /* Prevent zoom on input focus - must be 16px or larger */
      .search-input {
        font-size: 16px;
      }

      .search-button {
        background: #000000;
        border: 1px solid #666666;
      }

      .search-button:hover {
        background: #1a1a1a;
      }

      .search-button svg {
        fill: #888888;
      }

      /* Mobile logo pulse */
      .mobile-logo.logo-pulsing .mobile-logo-img {
        animation: logo-pulse 1s ease-in-out infinite;
      }

      .mobile-section {
        background: rgba(139, 92, 246, 0.05);
        border: 1px solid #8b5cf6;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        overflow: hidden;
        box-sizing: border-box;
      }

      .mobile-section-title {
        color: #ffffff;
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(139, 92, 246, 0.2);
      }

      .mobile-logos {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        width: 100%;
        box-sizing: border-box;
      }

      .mobile-logo {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        padding: 4px;
        min-width: 0;
        overflow: hidden;
      }

      .mobile-logo-img {
        width: 48px;
        max-width: 100%;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 1.5px solid #8b5cf6;
        background: rgba(0, 0, 0, 0.6);
        margin-bottom: 6px;
        flex-shrink: 0;
      }

      .mobile-logo-placeholder {
        width: 48px;
        max-width: 100%;
        height: 48px;
        border-radius: 50%;
        border: 1.5px solid #8b5cf6;
        background: rgba(0, 0, 0, 0.6);
        margin-bottom: 6px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        color: #8b5cf6;
        font-weight: 600;
      }

      .mobile-logo-name {
        color: #ffffff;
        font-size: 9px;
        font-weight: 500;
        text-align: center;
        line-height: 1.2;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      /* Council section - 3 logos per row, no text labels, vertically centered */
      .mobile-section.council .mobile-logos {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        align-items: center;
      }

      .mobile-section.council .mobile-logo {
        padding: 8px 4px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 50px;
      }

      .mobile-section.council .mobile-logo-img {
        width: auto !important;
        max-width: 100%;
        max-height: 80px;
        border-radius: 4px;
        object-fit: contain;
        background: transparent;
        border: none;
        margin-bottom: 0;
      }

      .mobile-section.council .mobile-logo-placeholder {
        width: 80px;
        height: 35px;
        border-radius: 4px;
        font-size: 12px;
        margin-bottom: 0;
      }

      .mobile-section.council .mobile-logo-name {
        display: none;
      }

      /* Core orgs - 3 logos per row, no text labels, vertically centered */
      .mobile-section.core-orgs .mobile-logos {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        align-items: center;
      }

      .mobile-section.core-orgs .mobile-logo {
        padding: 8px 4px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 90px;
      }

      .mobile-section.core-orgs .mobile-logo-img {
        width: auto !important;
        max-width: 100%;
        border-radius: 4px;
        object-fit: contain;
        background: transparent;
        border: none;
        margin-bottom: 0;
      }

      .mobile-section.core-orgs .mobile-logo-placeholder {
        width: 100%;
        height: 30px;
        border-radius: 4px;
        font-size: 10px;
        margin-bottom: 0;
      }

      .mobile-section.core-orgs .mobile-logo-name {
        display: none;
      }

      /* Native services - text based */
      .mobile-section.native-services .mobile-logos {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .mobile-native-service {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        padding: 12px 8px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 8px;
      }

      .mobile-native-abbrev {
        color: #8b5cf6;
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .mobile-native-name {
        color: #ffffff;
        font-size: 10px;
        font-weight: 500;
        text-align: center;
        line-height: 1.3;
      }

      .mobile-footer {
        text-align: center;
        padding: 20px;
        color: #c4b5fd;
        font-size: 11px;
        border-top: 1px solid rgba(139, 92, 246, 0.3);
        margin-top: 20px;
      }

      .mobile-footer a {
        color: #8b5cf6;
        text-decoration: none;
      }
    }

    /* Shared styles */
    .top-link {
      position: fixed;
      top: 20px;
      right: 55px; /* Moved 25px left from 30px */
      color: #ffffff;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      z-index: 100;
      transition: color 0.2s ease;
    }

    .top-link:hover {
      color: #8b5cf6;
    }

    /* Modal styles (desktop only) */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(8px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-wrapper {
      position: relative;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 10px;
    }

    .modal-content {
      background: #0a0a0f;
      border: 1px solid #8b5cf6;
      border-radius: 16px;
      padding: 30px;
      max-width: 85vw;
      max-height: 85vh;
      overflow: auto;
      position: relative;
      box-shadow: 0 25px 60px rgba(139, 92, 246, 0.3);
    }

    .modal-close {
      background: #0a0a0f;
      border: 1px solid #8b5cf6;
      color: #8b5cf6;
      font-size: 24px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .modal-close:hover {
      background: #8b5cf6;
      color: #ffffff;
    }

    .modal-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 24px;
      border-bottom: 1px solid rgba(139, 92, 246, 0.3);
      padding-bottom: 16px;
    }

    .modal-title {
      color: #8b5cf6;
      font-size: 24px;
      font-weight: 700;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 24px;
    }

    .modal-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      padding: 16px;
      border-radius: 12px;
      background: rgba(139, 92, 246, 0.05);
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }

    .modal-item:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: #8b5cf6;
      transform: translateY(-2px);
    }

    .modal-item-logo {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #8b5cf6;
      background: rgba(0, 0, 0, 0.6);
      margin-bottom: 12px;
    }

    .modal-item-name {
      color: #ffffff;
      font-size: 12px;
      font-weight: 500;
      text-align: center;
      line-height: 1.3;
    }

    /* Council section modal - 3 logos per row */
    .modal-grid.council {
      grid-template-columns: repeat(3, 1fr);
    }

    .council .modal-item-logo {
      width: 140px;
      height: 80px;
      border-radius: 8px;
      object-fit: contain;
      padding: 10px;
      background: transparent;
    }

    /* Core orgs modal */
    .modal-grid.core-orgs {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }

    .core-orgs .modal-item-logo {
      width: 180px;
      height: 60px;
      border-radius: 8px;
      object-fit: contain;
      padding: 10px;
      background: transparent;
      border: none;
    }
  </style>
</head>
<body>
  <a href="https://hedera-data-app.vercel.app" target="_blank" rel="noopener noreferrer" class="top-link">Hedera Data Dashboard</a>

  <!-- Desktop Search Bar (positioned dynamically via JavaScript) -->
  <div class="desktop-search-container" id="desktop-search-container">
    <div class="search-bar" id="desktop-search-bar">
      <input type="text" class="search-input" id="desktop-search-input" placeholder="Search for an entity..." spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" data-form-type="other">
      <span class="search-result" id="desktop-search-result"></span>
      <button class="search-button" id="desktop-search-button">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
      </button>
    </div>
  </div>

  <!-- Desktop SVG Map -->
  <div class="map-container" id="map-container">
    SVG_CONTENT_PLACEHOLDER
  </div>

  <!-- Mobile Layout -->
  <div class="mobile-container" id="mobile-container">
    <div class="mobile-header">
      <h1><a href="https://hedera.com" target="_blank" rel="noopener noreferrer" style="color: #ffffff; text-decoration: none;">Hedera</a> Ecosystem Map</h1>
      <p>An Incomplete Map of the Hedera Ecosystem</p>
      <!-- Mobile Search Bar -->
      <div class="search-container">
        <div class="search-bar">
          <input type="text" class="search-input" id="mobile-search-input" placeholder="Search for an entity..." spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" data-form-type="other">
          <span class="search-result" id="mobile-search-result"></span>
          <button class="search-button" id="mobile-search-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          </button>
        </div>
      </div>
    </div>
    MOBILE_SECTIONS_PLACEHOLDER
    <div class="mobile-footer">
      <p>Data updates regularly. The list of projects is not comprehensive.</p>
      <p style="margin-top: 8px;">Built by <a href="https://genfinity.io" target="_blank" rel="noopener noreferrer"><img src="GENFINITY_LOGO_PLACEHOLDER" alt="Genfinity" style="height: 18px; vertical-align: middle;"></a></p>
    </div>
  </div>

  <!-- Desktop Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-wrapper">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title">Section</h2>
        </div>
        <div class="modal-grid" id="modal-grid">
          <!-- Items will be populated here -->
        </div>
      </div>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
  </div>

  <script>
    // Section data from the CSV (will be populated by the build script)
    const sectionData = SECTION_DATA_PLACEHOLDER;

    // Check if mobile
    const isMobile = () => window.innerWidth <= 768;

    // Track hover state per section
    const hoverState = new Map();

    // Initialize the map
    function init() {
      // Skip desktop interactivity on mobile
      if (isMobile()) return;

      // Add click handlers to entire section groups (not just titles)
      const sectionGroups = document.querySelectorAll('.section-group');
      sectionGroups.forEach(group => {
        const isCouncil = group.classList.contains('council-section');

        // Initialize hover state for this group
        hoverState.set(group, {
          timeout: null,
          isHovered: false,
          hoveredRect: null,
          boundChecker: null
        });

        function activateHover() {
          if (isMobile()) return;
          const state = hoverState.get(group);
          state.isHovered = true;

          // Move this group to the end of its parent to render on top
          const parent = group.parentNode;
          parent.appendChild(group);

          // Use requestAnimationFrame to ensure transition applies after DOM move
          requestAnimationFrame(() => {
            if (isCouncil) {
              // Special handling for council section: fade and grow to 5-column layout
              const normalGroup = group.querySelector('.council-normal');
              const hoverGroup = group.querySelector('.council-hover');
              const mainTitle = group.querySelector(':scope > .section-title');
              if (normalGroup) normalGroup.classList.add('hidden');
              if (hoverGroup) hoverGroup.classList.add('visible');
              if (mainTitle) mainTitle.classList.add('hidden'); // Hide main title with hover activation
              // No section transform - hover group animates its own scale via CSS
            } else {
              // Apply the calculated max scale from data attribute
              const maxScale = parseFloat(group.getAttribute('data-max-scale')) || 1.8;
              group.style.transform = `scale(${maxScale})`;
            }

            // Set up bound checking after animation completes
            setTimeout(() => {
              if (state.isHovered) {
                if (isCouncil) {
                  // For council, use SVG coordinates and EXPANDED hover bounds from data attributes
                  const hoverX = parseFloat(group.getAttribute('data-hover-x'));
                  const hoverY = parseFloat(group.getAttribute('data-hover-y'));
                  const hoverW = parseFloat(group.getAttribute('data-hover-w'));
                  const hoverH = parseFloat(group.getAttribute('data-hover-h'));

                  state.boundChecker = (e) => {
                    if (state.isHovered) {
                      const svgPoint = screenToSVG(e.clientX, e.clientY);
                      if (svgPoint && !isWithinBounds(svgPoint, hoverX, hoverY, hoverW, hoverH)) {
                        deactivateHover();
                      }
                    }
                  };
                  state.hoveredRect = { council: true }; // Mark as active
                } else {
                  // For other sections, use screen coordinates and panel bounds
                  const panel = group.querySelector('.panel');
                  if (panel) {
                    state.hoveredRect = panel.getBoundingClientRect();
                  } else {
                    state.hoveredRect = group.getBoundingClientRect();
                  }

                  state.boundChecker = (e) => {
                    if (state.isHovered && state.hoveredRect) {
                      const x = e.clientX;
                      const y = e.clientY;
                      const rect = state.hoveredRect;
                      if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                        deactivateHover();
                      }
                    }
                  };
                }
                document.addEventListener('mousemove', state.boundChecker);
              }
            }, 350); // Wait for 300ms transition + small buffer
          });
        }

        function deactivateHover() {
          const state = hoverState.get(group);

          // Clear timeout if pending
          if (state.timeout) {
            clearTimeout(state.timeout);
            state.timeout = null;
          }

          // Remove bound checker
          if (state.boundChecker) {
            document.removeEventListener('mousemove', state.boundChecker);
            state.boundChecker = null;
          }

          state.isHovered = false;
          state.hoveredRect = null;

          if (isCouncil) {
            // Fade back to normal 2-column layout
            const normalGroup = group.querySelector('.council-normal');
            const hoverGroup = group.querySelector('.council-hover');
            const mainTitle = group.querySelector(':scope > .section-title');
            if (normalGroup) normalGroup.classList.remove('hidden');
            if (hoverGroup) hoverGroup.classList.remove('visible');
            if (mainTitle) mainTitle.classList.remove('hidden'); // Show main title again
          }
          // Reset scale on mouse leave
          group.style.transform = 'scale(1)';
        }

        // Helper to convert screen coordinates to SVG coordinates
        function screenToSVG(screenX, screenY) {
          const svg = document.querySelector('.map-container svg');
          if (!svg) return null;
          const svgRect = svg.getBoundingClientRect();
          const viewBoxWidth = 1920;
          const viewBoxHeight = 1080;
          const scaleX = svgRect.width / viewBoxWidth;
          const scaleY = svgRect.height / viewBoxHeight;
          const scale = Math.min(scaleX, scaleY);
          const scaledWidth = viewBoxWidth * scale;
          const scaledHeight = viewBoxHeight * scale;
          const offsetX = (svgRect.width - scaledWidth) / 2;
          const offsetY = (svgRect.height - scaledHeight) / 2;
          const svgX = (screenX - svgRect.left - offsetX) / scale;
          const svgY = (screenY - svgRect.top - offsetY) / scale;
          return { x: svgX, y: svgY };
        }

        // For council section, check if point is within specified bounds
        function isWithinBounds(svgPoint, x, y, w, h) {
          return svgPoint.x >= x && svgPoint.x <= x + w &&
                 svgPoint.y >= y && svgPoint.y <= y + h;
        }

        group.addEventListener('mouseenter', (e) => {
          if (isMobile()) return;
          const state = hoverState.get(group);

          // For council section, only activate if mouse is within NORMAL panel bounds
          if (isCouncil) {
            const normalX = parseFloat(group.getAttribute('data-normal-x'));
            const normalY = parseFloat(group.getAttribute('data-normal-y'));
            const normalW = parseFloat(group.getAttribute('data-normal-w'));
            const normalH = parseFloat(group.getAttribute('data-normal-h'));
            const svgPoint = screenToSVG(e.clientX, e.clientY);
            if (!svgPoint || !isWithinBounds(svgPoint, normalX, normalY, normalW, normalH)) {
              return; // Don't activate - mouse is not in normal panel area
            }
          }

          // Delay hover activation by 0.75 seconds
          state.timeout = setTimeout(activateHover, 750);
        });

        group.addEventListener('mouseleave', () => {
          if (isMobile()) return;
          // Only deactivate if hover hasn't fully activated yet
          // Once hoveredRect is set, we use bounds checking instead
          const state = hoverState.get(group);
          if (!state.hoveredRect) {
            deactivateHover();
          }
        });

        // Make entire section clickable for popup (desktop only)
        group.addEventListener('click', (e) => {
          if (isMobile()) return;
          // Don't trigger if clicking on a link inside the section
          if (e.target.closest('a')) return;

          const sectionName = group.getAttribute('data-section');
          if (sectionName) {
            openSectionModal(sectionName);
          }
        });
      });

      // Close modal on overlay click
      document.getElementById('modal-overlay').addEventListener('click', (e) => {
        if (e.target.id === 'modal-overlay') {
          closeModal();
        }
      });

      // Close modal on button click
      document.getElementById('modal-close').addEventListener('click', closeModal);

      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    }

    function openSectionModal(sectionName) {
      if (isMobile()) return;

      const section = sectionData[sectionName];
      if (!section) return;

      document.getElementById('modal-title').textContent = sectionName;

      const grid = document.getElementById('modal-grid');
      grid.className = 'modal-grid';

      // Add special class for council/core orgs
      if (sectionName === 'Hedera Council') {
        grid.classList.add('council');
      } else if (sectionName === 'Independent Core Organizations') {
        grid.classList.add('core-orgs');
      }

      // Get all items from subcategories
      const items = Object.values(section.subcategories).flat();

      grid.innerHTML = items.map(item => {
        const logoSrc = item.logoDataUri || '';
        const hasWebsite = item.website && item.website.trim() !== '';
        return `
          <a class="modal-item" ${hasWebsite ? `href="${item.website}" target="_blank" rel="noopener noreferrer"` : 'style="cursor:default;"'}>
            ${logoSrc ? `<img class="modal-item-logo" src="${logoSrc}" alt="${item.entity}">` :
              `<div class="modal-item-logo" style="display:flex;justify-content:center;align-items:center;font-size:20px;color:#8b5cf6;font-weight:bold;">${item.entity.substring(0, 2).toUpperCase()}</div>`}
            <span class="modal-item-name">${item.entity}</span>
          </a>
        `;
      }).join('');

      document.getElementById('modal-overlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Search functionality
    function searchEntity(searchTerm, isMobileSearch) {
      let term = searchTerm.trim().toLowerCase();
      if (!term) return;

      // Search aliases for common alternative names
      const searchAliases = {
        'aberdeen': 'abrdn',
        'aberdeen standard': 'abrdn',
        'aberdeen standard investments': 'abrdn',
        'hash name service': 'HNS',
        'hashname': 'Hashgraph.Name',
        'hash names': 'Hashgraph.Name',
        'hashnames': 'Hashgraph.Name',
        'hedera name service': 'HNS',
        'hns domains': 'HNS'
      };

      // Check if the search term matches an alias
      const aliasMatch = searchAliases[term];
      if (aliasMatch) {
        term = aliasMatch.toLowerCase();
      }

      // Build list of all entities from sectionData
      const allEntities = [];
      Object.entries(sectionData).forEach(([sectionName, section]) => {
        Object.entries(section.subcategories).forEach(([subcatName, items]) => {
          items.forEach(item => {
            allEntities.push({
              entity: item.entity,
              section: sectionName,
              subcategory: subcatName,
              website: item.website
            });
          });
        });
      });

      // Find matching entity - try exact match first, then partial matching
      let match = allEntities.find(item =>
        item.entity.toLowerCase() === term
      );

      // If no exact match and term is 3+ chars, try partial matching
      if (!match && term.length >= 3) {
        // Try starts-with match (e.g., "zain" -> "Zain Group")
        match = allEntities.find(item =>
          item.entity.toLowerCase().startsWith(term)
        );

        // Try contains match (e.g., "telekom" -> "Deutsche Telekom")
        if (!match) {
          match = allEntities.find(item =>
            item.entity.toLowerCase().includes(term)
          );
        }
      }

      const resultElement = isMobileSearch
        ? document.getElementById('mobile-search-result')
        : document.getElementById('desktop-search-result');
      const inputElement = isMobileSearch
        ? document.getElementById('mobile-search-input')
        : document.getElementById('desktop-search-input');

      // Clear previous pulse animations
      document.querySelectorAll('.logo-pulsing').forEach(el => {
        el.classList.remove('logo-pulsing');
      });

      // Special case: check for Genfinity
      let isGenfinity = term.includes('genfinity') || 'genfinity'.includes(term);

      if (match || isGenfinity) {
        // Found
        resultElement.textContent = 'Confirmed on the Map';
        resultElement.classList.remove('not-found');
        resultElement.classList.add('visible');
        inputElement.style.visibility = 'hidden';

        // Find and pulse the logo
        if (isMobileSearch) {
          // Mobile: find the logo in mobile sections
          const mobileLogos = document.querySelectorAll('.mobile-logo');
          let foundLogo = null;

          if (isGenfinity) {
            // Find Genfinity logo in footer
            const genfinityImg = document.querySelector('.mobile-footer img[alt="Genfinity"]');
            if (genfinityImg) {
              genfinityImg.closest('.mobile-footer').scrollIntoView({ behavior: 'smooth', block: 'center' });
              genfinityImg.classList.add('logo-pulsing');
              setTimeout(() => genfinityImg.classList.remove('logo-pulsing'), 10000);
            }
          } else {
            mobileLogos.forEach(logo => {
              // First try the text name element
              const nameEl = logo.querySelector('.mobile-logo-name');
              if (nameEl && nameEl.textContent.trim().toLowerCase() === match.entity.toLowerCase()) {
                foundLogo = logo;
              }

              // For council/core-orgs, check the img alt attribute (names are hidden)
              if (!foundLogo) {
                const img = logo.querySelector('.mobile-logo-img');
                if (img && img.alt && img.alt.toLowerCase() === match.entity.toLowerCase()) {
                  foundLogo = logo;
                }
              }
            });

            if (foundLogo) {
              // For council section, scroll to the specific logo (not just the section)
              // This ensures the pulsing logo is centered on screen
              const section = foundLogo.closest('.mobile-section');
              const isCouncilSection = section && section.classList.contains('council');

              if (isCouncilSection) {
                // Scroll to the actual logo element for council
                foundLogo.scrollIntoView({ behavior: 'smooth', block: 'center' });
              } else if (section) {
                // For other sections, scroll to section
                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }

              // Add pulse animation to the image directly
              setTimeout(() => {
                const img = foundLogo.querySelector('.mobile-logo-img');
                if (img) {
                  img.classList.add('logo-pulsing');
                  setTimeout(() => img.classList.remove('logo-pulsing'), 10000);
                } else {
                  foundLogo.classList.add('logo-pulsing');
                  setTimeout(() => foundLogo.classList.remove('logo-pulsing'), 10000);
                }
              }, 500);
            }
          }
        } else {
          // Desktop: find the logo in SVG and activate section hover
          const svgElement = document.querySelector('.map-container svg');
          let foundImage = null;
          let foundSection = null;

          if (isGenfinity) {
            // Find Genfinity logo
            const genfinityLink = document.querySelector('a[href="https://genfinity.io"]');
            if (genfinityLink) {
              foundImage = genfinityLink.querySelector('image');
            }
          } else if (svgElement) {
            // Search all logo-link elements and combine their label texts for full name match
            const allLogoLinks = svgElement.querySelectorAll('a.logo-link');

            allLogoLinks.forEach(logoLink => {
              // Get all logo-label text elements and combine them
              const labelTexts = logoLink.querySelectorAll('.logo-label');
              const fullName = Array.from(labelTexts)
                .map(t => t.textContent.trim())
                .join('')
                .toLowerCase();

              if (fullName === match.entity.toLowerCase()) {
                const image = logoLink.querySelector('image');
                if (image) {
                  foundImage = image;
                  // Find the section group containing this logo
                  foundSection = logoLink.closest('.section-group');
                }
              }
            });

            // If not found by label text, try finding by website URL (for Core Orgs which have no text labels)
            if (!foundImage && match.website) {
              const linkByUrl = svgElement.querySelector(`a.logo-link[href="${match.website}"]`);
              if (linkByUrl) {
                foundImage = linkByUrl.querySelector('image');
                foundSection = linkByUrl.closest('.section-group');
              }
            }
          }

          // Activate section hover state
          if (foundSection) {
            activateSectionHover(foundSection);
            // Deactivate after 10 seconds
            setTimeout(() => deactivateSectionHover(foundSection), 10000);
          }

          // For Council section, find the logo in council-hover group (not council-normal)
          if (foundSection && foundSection.classList.contains('council-section') && match.website) {
            const hoverGroup = foundSection.querySelector('.council-hover');
            if (hoverGroup) {
              const hoverLink = hoverGroup.querySelector(`a.logo-link[href="${match.website}"]`);
              if (hoverLink) {
                foundImage = hoverLink.querySelector('image');
              }
            }
          }

          // Pulse the logo
          if (foundImage) {
            foundImage.classList.add('logo-pulsing');
            setTimeout(() => foundImage.classList.remove('logo-pulsing'), 10000);
          }
        }

        // Reset after 5 seconds
        setTimeout(() => {
          resultElement.classList.remove('visible');
          inputElement.style.visibility = 'visible';
          inputElement.value = '';
        }, 5000);
      } else {
        // Not found
        resultElement.textContent = 'Not on the map yet';
        resultElement.classList.add('not-found');
        resultElement.classList.add('visible');
        inputElement.style.visibility = 'hidden';

        // Reset after 3 seconds
        setTimeout(() => {
          resultElement.classList.remove('visible', 'not-found');
          inputElement.style.visibility = 'visible';
          inputElement.value = '';
        }, 3000);
      }
    }

    // Position desktop search bar relative to SVG
    function positionDesktopSearch() {
      if (isMobile()) return;

      const container = document.getElementById('map-container');
      const searchContainer = document.getElementById('desktop-search-container');
      const svg = container ? container.querySelector('svg') : null;

      if (!svg || !searchContainer) return;

      // SVG viewBox is 1920x1080, title is at x=40, y=64 (18px font)
      // We want search bar below title, at approximately x=40, y=80 in SVG coordinates
      const svgRect = svg.getBoundingClientRect();

      // Calculate scale factor (how much the SVG is scaled from its viewBox)
      const viewBoxWidth = 1920;
      const viewBoxHeight = 1080;
      const scaleX = svgRect.width / viewBoxWidth;
      const scaleY = svgRect.height / viewBoxHeight;
      const scale = Math.min(scaleX, scaleY); // object-fit: contain uses min scale

      // Calculate offset (centering due to object-fit: contain)
      const scaledWidth = viewBoxWidth * scale;
      const scaledHeight = viewBoxHeight * scale;
      const offsetX = (svgRect.width - scaledWidth) / 2;
      const offsetY = (svgRect.height - scaledHeight) / 2;

      // Position in SVG coordinates: right edge aligned with Core Orgs section (x=1850)
      // Search bar width is 330, so left edge = 1850 - 330 = 1520
      const svgX = 1520;
      const svgY = 50;

      // Convert to screen coordinates (svgRect already includes container position)
      const screenX = svgRect.left + offsetX + (svgX * scale);
      const screenY = svgRect.top + offsetY + (svgY * scale);

      // Set search bar position
      searchContainer.style.position = 'fixed';
      searchContainer.style.left = screenX + 'px';
      searchContainer.style.top = screenY + 'px';

      // Set fixed width that scales with the map - 1.5x longer, 10% taller
      const baseWidth = 330;
      const scaledBarWidth = baseWidth * scale;

      const searchBar = searchContainer.querySelector('.search-bar');
      if (searchBar) {
        searchBar.style.width = scaledBarWidth + 'px';
        searchBar.style.height = (35 * scale) + 'px';
        searchBar.style.fontSize = (12 * scale) + 'px';
        searchBar.style.padding = `${4 * scale}px ${4 * scale}px ${4 * scale}px ${14 * scale}px`;
      }

      const searchButton = searchContainer.querySelector('.search-button');
      if (searchButton) {
        const btnSize = 24 * scale;
        searchButton.style.width = btnSize + 'px';
        searchButton.style.height = btnSize + 'px';
      }

      const searchInput = searchContainer.querySelector('.search-input');
      if (searchInput) {
        searchInput.style.fontSize = (12 * scale) + 'px';
      }
    }

    // Set up search event listeners
    function initSearch() {
      // Desktop search
      const desktopInput = document.getElementById('desktop-search-input');
      const desktopButton = document.getElementById('desktop-search-button');

      if (desktopInput && desktopButton) {
        desktopButton.addEventListener('click', () => {
          searchEntity(desktopInput.value, false);
        });
        desktopInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            searchEntity(desktopInput.value, false);
          }
        });
      }

      // Mobile search
      const mobileInput = document.getElementById('mobile-search-input');
      const mobileButton = document.getElementById('mobile-search-button');

      if (mobileInput && mobileButton) {
        mobileButton.addEventListener('click', () => {
          searchEntity(mobileInput.value, true);
        });
        mobileInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            searchEntity(mobileInput.value, true);
          }
        });
      }

      // Position desktop search bar
      positionDesktopSearch();
      window.addEventListener('resize', positionDesktopSearch);
    }

    // Function to activate hover state on a section
    function activateSectionHover(sectionGroup) {
      if (!sectionGroup) return;

      const isCouncil = sectionGroup.classList.contains('council-section');

      // Move to end of parent to render on top
      const parent = sectionGroup.parentNode;
      parent.appendChild(sectionGroup);

      requestAnimationFrame(() => {
        if (isCouncil) {
          const normalGroup = sectionGroup.querySelector('.council-normal');
          const hoverGroup = sectionGroup.querySelector('.council-hover');
          const mainTitle = sectionGroup.querySelector(':scope > .section-title');
          if (normalGroup) normalGroup.classList.add('hidden');
          if (hoverGroup) hoverGroup.classList.add('visible');
          if (mainTitle) mainTitle.classList.add('hidden');

          // Set the hover group's panel to solid black (it's inside council-hover)
          const hoverPanel = hoverGroup ? hoverGroup.querySelector('.panel') : null;
          if (hoverPanel) {
            hoverPanel.style.fill = '#000000';
          }
        } else {
          // Set panel to solid black background for non-council sections
          const panel = sectionGroup.querySelector('.panel');
          if (panel) {
            panel.style.fill = '#000000';
          }
          const maxScale = parseFloat(sectionGroup.getAttribute('data-max-scale')) || 1.8;
          sectionGroup.style.transform = `scale(${maxScale})`;
        }
      });
    }

    // Function to deactivate hover state on a section
    function deactivateSectionHover(sectionGroup) {
      if (!sectionGroup) return;

      const isCouncil = sectionGroup.classList.contains('council-section');

      if (isCouncil) {
        const normalGroup = sectionGroup.querySelector('.council-normal');
        const hoverGroup = sectionGroup.querySelector('.council-hover');
        const mainTitle = sectionGroup.querySelector(':scope > .section-title');

        // Reset the hover group's panel background
        const hoverPanel = hoverGroup ? hoverGroup.querySelector('.panel') : null;
        if (hoverPanel) {
          hoverPanel.style.fill = '';
        }

        if (normalGroup) normalGroup.classList.remove('hidden');
        if (hoverGroup) hoverGroup.classList.remove('visible');
        if (mainTitle) mainTitle.classList.remove('hidden');
      } else {
        // Reset panel background for non-council sections
        const panel = sectionGroup.querySelector('.panel');
        if (panel) {
          panel.style.fill = '';
        }
      }
      sectionGroup.style.transform = 'scale(1)';
    }

    // Start the app
    init();
    initSearch();
  </script>
</body>
</html>
